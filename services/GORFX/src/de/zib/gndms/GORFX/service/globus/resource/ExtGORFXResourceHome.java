package de.zib.gndms.GORFX.service.globus.resource;

import de.zib.gndms.GORFX.service.GORFXConfiguration;
import de.zib.gndms.infra.GridConfig;
import de.zib.gndms.infra.GNDMSTools;
import de.zib.gndms.infra.system.GNDMSystem;
import org.apache.axis.message.addressing.AttributedURI;
import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;
import org.jetbrains.annotations.NotNull;
import org.globus.wsrf.Resource;
import org.globus.wsrf.ResourceException;

import javax.naming.NamingException;

/**
 * This class overrides the ResourceHome that is automatically generated by introduce for Globus
 * Toolkit. In GNDMS this is mainly necessary to provide RDBMS/JPA-based resource persistence.
 * In order to use the extended resource home they have to be configured in jndi-config.xml.
 * If this has been done properly, you should see an info-level log message during the start up
 * of the web service container that notifies succesfull initialization of the extended resource
 * home.
 *
 * @author Stefan Plantikow <plantikow@zib.de>
 * @version $Id$
 *
 *          User: stepn Date: 16.07.2008 Time: 12:35:27
 */
public final class ExtGORFXResourceHome extends GORFXResourceHome {

    // logger can be an instance field since resource home classes are instantiated at most once
	@NotNull
	@SuppressWarnings({"FieldNameHidesFieldInSuperclass"})
	private final Log logger = LogFactory.getLog(ExtGORFXResourceHome.class);

    // System: Set during initialization
    @SuppressWarnings({"FieldAccessedSynchronizedAndUnsynchronized"})
    @NotNull
    private GNDMSystem system;

    // Serbice Address: set during initialization
    @SuppressWarnings({"FieldAccessedSynchronizedAndUnsynchronized"})
    private AttributedURI serviceAddress;

    private boolean initialized;


    // grid config for gndmsystem initialization
    @SuppressWarnings({"StaticVariableOfConcreteClass"})
    private static final GridConfig SHARED_CONFIG = new GridConfig() {
        @Override @NotNull
        public String getGridJNDIEnvName() throws Exception
        { return GORFXConfiguration.getConfiguration().getGridJNDIEnv(); }

        @Override @NotNull
        public String getGridName() throws Exception
        { return GORFXConfiguration.getConfiguration().getGridName(); }

        @Override @NotNull
        public String getGridPath() throws Exception
        { return GORFXConfiguration.getConfiguration().getGridPath(); }

    };


    public static GridConfig getGridConfig() {
        return SHARED_CONFIG;
    }

    @Override
	public synchronized void initialize() throws Exception {
		super.initialize();
        if (! initialized) {
			logger.info("GORFX home extension initializing");
			try {
				system = getGridConfig().retrieveSystemReference();
				serviceAddress = GNDMSTools.getServiceAddressFromContext();

				initialized = true;

				try {
					super.initialize();    // Overridden method
				}
				catch (RuntimeException e) {
					initialized = false;
					logger.error(e);
					throw e;
				}
			}
			catch ( NamingException e) {
				logger.error("Initialization failed");
				throw new RuntimeException(e);
			}
		}
    }


    private void ensureInitialized() {
        try
        { initialize();	}
        catch (Exception e) {
            logger.error("Unexpected initialization error", e);
            throw new RuntimeException(e);
        }
    }


    public GNDMSystem getSystem() {
        ensureInitialized(); 
        return system;
    }


    public void setSystem( GNDMSystem system ) {
        throw new UnsupportedOperationException( "Attribute \"system\" is read-only" );
    }


    @NotNull
	public AttributedURI getServiceAddress() {
		ensureInitialized();
		return serviceAddress;
	}


    @NotNull
    public String getNickName() {
        return "GORFX";
    }


      @Override
	public Resource createSingleton() {

          final GORFXResource resource = new GORFXResource();
          resource.setHome(this);
          return resource;
	}
}
