<project name="service compilation file" basedir=".">
	
	
	<!-- Define the environment variable -->
	<property environment="env"/>
	
	<!-- Do always load properties in the following order: ${gndms.basedir},${gndms.properties},${gndms.deps},${others.properties} -->
	
	<!-- Basedir of gndms. -->
	<property name="gndms.basedir" value="${basedir}"/>
	
	<!-- Loading global project-settings.-->
	<property file="gndms.properties"/>
	
	<!-- Loading global project-dependencies -->
	<property file="gndms.deps"/>
	
	<!-- Loading local project-properties-->
	<property file="build-services.properties"/>
	
	
	<!-- using ant contrib for contidionals, looping , and runtarget -->
	<taskdef resource="net/sf/antcontrib/antlib.xml">
		<classpath>
			<pathelement location="${ant.contrib}" />
		</classpath>
	</taskdef>
	
	
	<!-- Building stubs for every service -->
	<target name='stubs.compile' description="Builds stubs for every service">
		<exec executable="sh">
			<arg value="-c"/>
			<arg value="for i in services/* ; do ( cd $i &amp;&amp; ant compileStubs ) ; done"/>
		</exec>
	</target>
	
	
	<!-- Creates needed deployment-gars for globus-->
	<target name="buildGar" description="creates needed deployment-gars">
		<exec executable="sh">
			<arg value="-c"/>
			<arg value="for i in services/* ; do ( cd $i &amp;&amp; ant createDeploymentGar ) ; done"/>
		</exec>
	</target>
	
	
	<!-- class-files needed to compile DSpace -->
	<path id="dspace.path">
		<pathelement path="${GROOVY}"/> 
		<pathelement path="${annotations}"/>
		<dirset dir="${dspace.stubs}" />
		<pathelement path="${gndms-infra}"/>
		<pathelement location="${gndms-kit}"/>
		<pathelement location="${gndms-logic}"/>
		<pathelement location="${gndms-shared-model}"/>
		<pathelement location="${stuff}"/>
		<pathelement path="${joda-time}"/> 
		<dirset dir="${dspace.dir}/src/" />
		<pathelement path="${dspace.nonsym}"/>
		<pathelement path="${gt4}"/>
		<pathelement path="${openjpa}"/>
		<pathelement path="${guice}"/>
	</path>

	
	<!-- class-files needed to compile DSpace-Test -->
	<path id="dspace.test.path">
		<path refid="dspace.path"/>
		<pathelement location="${lib.dir}/DSpace.jar"/>
		<pathelement path="${testng}"/>
	</path>
	
	<!-- class-files needed to compile GORFX -->
	<path id="gorfx.path">
		<pathelement path="${GROOVY}"/> 
		<pathelement path="${annotations}"/>
		<dirset dir="${gorfx.dir}/build/stubs-GORFX/classes/" />
		<pathelement location="${gndms-typecon}"/>
		<pathelement location="${gndms-infra}"/>
		<pathelement location="${gndms-kit}"/>
		<pathelement location="${gndms-logic}"/>
		<pathelement location="${gndms-shared-model}"/>
		<pathelement location="${stuff}"/>
		<pathelement location="${joda-time}"/> 
		<dirset dir="${gorfx.dir}/src/" />
		<pathelement path="${gorfx.nonsym}"/>
		<pathelement path="${gt4}"/>
		<pathelement path="${openjpa}"/>
		<pathelement location="${lib.dir}/DSpace.jar"/>
		<pathelement path="${args4j}"/>
		<dirset dir="${dspace.dir}/build/stubs-DSpace/classes/" />
		<pathelement path="${jaxb}"/>
		<pathelement path="${guice}"/>
	</path>
	
	<!-- class-files needed to compile GORFX-Test -->
	<path id="gorfx.test.path">
		<path refid="gorfx.path"/>
		<pathelement location="${gorfx.dir}/GORFX.jar"/>
		<pathelement path="${testng}"/>
	</path>
	
	<!-- class-files needed to compile LOFIS -->
	<path id="lofis.path">
		<pathelement path="${GROOVY}"/> 
		<pathelement path="${annotations}"/>
		<dirset dir="${lofis.stubs}" />
		<pathelement path="${gndms-infra}"/>
		<pathelement location="${gndms-kit}"/>
		<pathelement location="${gndms-logic}"/>
		<pathelement location="${gndms-shared-model}"/>
		<pathelement location="${stuff}"/>
		<pathelement path="${joda-time}"/> 
		<dirset dir="${lofis.dir}/src/" />
		<pathelement path="${dspace.nonsym}"/>
		<pathelement path="${gt4}"/>
		<pathelement path="${openjpa}"/>
		<pathelement path="${guice}"/>
	</path>
	
	
	<!-- class-files needed to compile LOFIS-Test -->
	<path id="lofis.test.path">
		<path refid="lofis.path"/>
	</path>
	<!-- class-files needed to compile WHORFX -->
	<path id="whorfx.path">
		<pathelement path="${GROOVY}"/> 
		<pathelement path="${annotations}"/>
		<dirset dir="${whorfx.stubs}" />
		<pathelement path="${gndms-infra}"/>
		<pathelement location="${gndms-kit}"/>
		<pathelement location="${gndms-logic}"/>
		<pathelement location="${gndms-shared-model}"/>
		<pathelement location="${stuff}"/>
		<pathelement path="${joda-time}"/> 
		<dirset dir="${whorfx.dir}/src/" />
		<pathelement path="${dspace.nonsym}"/>
		<pathelement path="${gt4}"/>
		<pathelement path="${openjpa}"/>
		<pathelement path="${guice}"/>
	</path>
	
	
	<!-- class-files needed to compile WHORFX-Test -->
	<path id="whorfx.test.path">
		<path refid="whorfx.path"/>
	</path>
	<!-- Compiles every service to service/ServiceName/out/.. and creates DSpace.jar aswell as GORFX.jar-->
	<target name='compile' description="compiles every service, creates DSpace.jar and GORFX.jar">
		<mkdir dir="${dspace.classes.dest}"/>
		<for param="jars">
			<path refid="dspace.path"/>
			<sequential>
				<if>
					<not>
						<available file="@{jars}"/>			
					</not>
					<then>
						<fail message="Not able to compile as '@{jars}' was not found."/>
					</then>
				</if>
				
			</sequential>
		</for>
		<echo>Compiling DSpace</echo>
		<javac srcdir='${dspace.dir}/src' destdir='${dspace.classes.dest}' classpathref="dspace.path" debug="${javac.debug}" />
		<!-- Copy Meta files to build dir-->
		<copy todir="${dspace.classes.dest}" >
			<fileset dir="${dspace.dir}/src">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
		<echo>Creating DSpace.jar</echo>
		<jar destfile="${lib.dir}/DSpace.jar"
		     basedir="${dspace.classes.dest}"/>
		
		<mkdir dir="${dspace.test.classes.dest}"/>
		<for param="jars">
			<path refid="dspace.test.path"/>
			<sequential>
				<if>
					<not>
						<available file="@{jars}"/>			
					</not>
					<then>
						<fail message="Not able to compile as '@{jars}' was not found."/>
					</then>
				</if>
				
			</sequential>
		</for>
		<echo>Creating DSpace test-classes</echo>
		<javac srcdir='${dspace.dir}/test' destdir='${dspace.test.classes.dest}' classpathref="dspace.test.path" debug="${javac.debug}" />
		<copy todir="${dspace.test.classes.dest}" >
			<fileset dir="${dspace.dir}/test">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
		
		<mkdir dir="${gorfx.classes.dest}"/>
		<for param="jars">
			<path refid="gorfx.path"/>
			<sequential>
				<if>
					<not>
						<available file="@{jars}"/>			
					</not>
					<then>
						<fail message="Not able to compile as '@{jars}' was not found."/>
					</then>
				</if>
				
			</sequential>
		</for>
		<javac srcdir='${gorfx.dir}/src' destdir='${gorfx.classes.dest}' classpathref="gorfx.path" debug="${javac.debug}"/>
		<jar destfile="${gorfx.dir}/GORFX.jar"
		     basedir="${gorfx.classes.dest}">
		</jar>
		
		<mkdir dir="${gorfx.test.classes.dest}"/>
		<for param="jars">
			<path refid="gorfx.test.path"/>
			<sequential>
				<if>
					<not>
						<available file="@{jars}"/>			
					</not>
					<then>
						<fail message="Not able to compile as '@{jars}' was not found."/>
					</then>
				</if>
				
			</sequential>
		</for>
		<echo>Compiling GORFX.jar</echo>
		<javac srcdir='${gorfx.dir}/test' destdir='${gorfx.test.classes.dest}' classpathref="gorfx.test.path" debug="${javac.debug}" />
		<copy todir="${gorfx.test.classes.dest}" >
			<fileset dir="${gorfx.dir}/test">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
		
		<mkdir dir="${lofis.classes.dest}"/>
		<for param="jars">
			<path refid="lofis.path"/>
			<sequential>
				<if>
					<not>
						<available file="@{jars}"/>			
					</not>
					<then>
						<fail message="Not able to compile as '@{jars}' was not found."/>
					</then>
				</if>
				
			</sequential>
		</for>
		<javac srcdir='${lofis.dir}/src' destdir='${lofis.classes.dest}' classpathref="lofis.path" debug="${javac.debug}"/>

		
		<mkdir dir="${lofis.test.classes.dest}"/>
		<for param="jars">
			<path refid="lofis.test.path"/>
			<sequential>
				<if>
					<not>
						<available file="@{jars}"/>			
					</not>
					<then>
						<fail message="Not able to compile as '@{jars}' was not found."/>
					</then>
				</if>
				
			</sequential>
		</for>
		<echo>Compiling LOFIS test-classes</echo>
		<javac srcdir='${lofis.dir}/test' destdir='${lofis.test.classes.dest}' classpathref="lofis.test.path" debug="${javac.debug}" />
		<copy todir="${lofis.test.classes.dest}" >
			<fileset dir="${lofis.dir}/test">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
		
		<mkdir dir="${whorfx.classes.dest}"/>
		<for param="jars">
			<path refid="whorfx.path"/>
			<sequential>
				<if>
					<not>
						<available file="@{jars}"/>			
					</not>
					<then>
						<fail message="Not able to compile as '@{jars}' was not found."/>
					</then>
				</if>
				
			</sequential>
		</for>
		<javac srcdir='${whorfx.dir}/src' destdir='${whorfx.classes.dest}' classpathref="whorfx.path" debug="${javac.debug}"/>
		
		<mkdir dir="${whorfx.test.classes.dest}"/>
		<for param="jars">
			<path refid="whorfx.test.path"/>
			<sequential>
				<if>
					<not>
						<available file="@{jars}"/>			
					</not>
					<then>
						<fail message="Not able to compile as '@{jars}' was not found."/>
					</then>
				</if>
				
			</sequential>
		</for>
		<echo>Compiling WHORFX test-classes</echo>
		<javac srcdir='${whorfx.dir}/test' destdir='${whorfx.test.classes.dest}' classpathref="whorfx.test.path" debug="${javac.debug}" />
		<copy todir="${whorfx.test.classes.dest}" >
			<fileset dir="${whorfx.dir}/test">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
	</target>
	
	<!-- Deletes all generated jar- and gar-files by the services.-->
	<target name="clean.services" description="deletes all generated jar- and gar-files by the services.">
		<delete file="${lib.dir}/DSpace.jar"/>
		<delete file="${gorfx.dir}/GORFX.jar"/>

		<delete>
			<fileset dir="${services.dir}" includes="**/c3*.gar"/>
		</delete> 

		<exec executable="sh">
			<arg value="-c"/>
			<arg value="find c3*.gar -type l -exec unlink &quot;{}&quot; &quot;;&quot; "/>
		</exec>
	</target>
	
	<!-- Deletes all generated class-files .-->
	<target name="clean.stubsServices" description="deletes all generated class-files">
		<delete dir="${dspace.dir}/out"/>
		<delete dir="${gorfx.dir}/out"/>
		<delete dir="${lofis.dir}/out"/>
		<delete dir="${whorfx.dir}/out"/>
		<exec executable="sh">
			<arg value="-c"/>
			<arg value="for i in services/* ; do ( cd $i &amp;&amp; ant clean) ; done"/>
		</exec>
		<exec executable="sh">
			<arg value="-c"/>
			<arg value="find services/*/lib -type l -exec unlink &quot;{}&quot; &quot;;&quot; "/>
		</exec>
	</target>
	
	<!-- Deletes all files generated by the services -->
	<target name="clean" depends="clean.stubsServices,clean.services" description="Deletes all files generated by the services"/>
</project>




