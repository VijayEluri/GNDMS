<?xml version="1.0"?>
<project name="Runs the OpenJPA enhancer">

<taskdef name="openjpac" classname="org.apache.openjpa.ant.PCEnhancerTask">
	<classpath>
		<fileset dir="../extra/tools-lib" id="tooljars">
			<include  name="*.jar" />
		</fileset>
	</classpath>
</taskdef>

<taskdef name="mappingtool" classname="org.apache.openjpa.jdbc.ant.MappingToolTask">
	<classpath>
		<fileset refid="tooljars" />
	</classpath>
</taskdef>

<fileset id="model_classes" dir="gndms-shared-model/production">
	<include name="de/zib/gndms/model/**/*" />
	<exclude name="de/zib/gndms/model/*" />
	<exclude name="de/zib/gndms/model/util/*" />
	<exclude name="de/zib/gndms/model/*/types/**" />
</fileset>

<target name="enhance" description="Calls the openjpa enhancer ant task on all classed in gndms-shared-model/production">

	<delete failonerror="false" file="../extra/lib/gndms-shared-model.jar" />

    <echo message="Basedir is '${basedir}'" />
	<openjpac directory="${basedir}/gndms-shared-model/production">
		<config propertiesFile="src/META-INF/persistence.xml" />
        
		<classpath>
			<pathelement location="gndms-shared-model/production" />
			<pathelement location="../stuff/gndms-stuff/production" />
			<fileset refid="tooljars" />
		</classpath>

		<fileset refid="model_classes" />

	</openjpac>

    <exec executable="hostname" osfamily="unix" failifexecutionfails="false" outputproperty="env.COMPUTERNAME"/>

    <property name="env.HOSTNAME" value="${env.COMPUTERNAME}"/>

    <tstamp>
        <format property="build.time" pattern="yyyy-MM-dd'T'HH:mm:ssZ" />
    </tstamp>

    <echo message="${build.time} ${user.name}@${env.HOSTNAME}" file="${basedir}/gndms-shared-model/production/META-INF/GNDMS-BUILD-INFO" />

    <loadfile srcfile="${basedir}/gndms-shared-model/production/META-INF/GNDMS-RELEASE" property="env.RELEASE" />

    <echo message="GNDMS RELEASE: ${env.RELEASE}" />
    <echo message="GNDMS BUILD: ${build.time} ${user.name}@${env.HOSTNAME}"/>

    <mkdir dir="gndms-shared-model/production/META-INF" />
    
    <copy file="src/META-INF/GNDMS-RELEASE" tofile="gndms-shared-model/production/META-INF/GNDMS-RELEASE" overwrite="true" />

	<jar file="../extra/lib/gndms-shared-model.jar" basedir="gndms-shared-model/production">
		<include name="**/*" />
	</jar>

</target>

<target name="map" description="Calls the OpenJPA mapping tool to build the current schema">
	<mappingtool schemaaction="build"
	             indexes="true" foreignkeys="true" primarykeys="true"
	             sqlfile="stdout">
		<config
			  connectionDriverName="org.apache.derby.jdbc.EmbeddedDriver"
			  connectionURL="jdbc:derby:/opt/gt-current/etc/c3grid_shared/db/c3grid"
			  propertiesFile="src/META-INF/persistence.xml"  />
                 <!--
		<config
			  connectionDriverName="org.apache.derby.jdbc.EmbeddedDriver"
              connectionURL="jdbc:derby:/home/mjorra/tmp/C3GridTests/db/ModelActionTests"
			  propertiesFile="src/META-INF/persistence.xml"  />
          -->

		<classpath>
			<pathelement location="gndms-shared-model/production" />
			<pathelement location="../stuff/gndms-stuff/production" />
            <fileset refid="tooljars" />
		</classpath>

		<fileset refid="model_classes" />
		
	</mappingtool>
</target>
</project>
