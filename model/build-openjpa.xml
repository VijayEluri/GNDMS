<?xml version="1.0"?>
<project name="Runs the OpenJPA enhancer">

<taskdef name="openjpac" classname="org.apache.openjpa.ant.PCEnhancerTask">
	<classpath id="enhancepath">
		<fileset dir="${basedir}/../extra/tools-lib" id="tooljars">
			<include  name="*.jar" />
		</fileset>    
		<pathelement location="${basedir}/gndms-shared-model/production" />
		<pathelement location="${basedir}/../stuff/gndms-stuff/production" />		
	</classpath>
</taskdef>

<taskdef name="mappingtool" classname="org.apache.openjpa.jdbc.ant.MappingToolTask">
	<classpath refid="enhancepath" />
</taskdef>

<target name="enhance" description="Calls the openjpa enhancer ant task on all classed in gndms-shared-model/production">
  <echo message="Basedir is '${basedir}'" />
	<openjpac directory="${basedir}/gndms-shared-model/production">
		<config propertiesFile="${basedir}/gndms-shared-model/production-resources/META-INF/persistence.xml" />
		<classpath refid="enhancepath" />
	</openjpac>
</target>

<target name="touchrel">
    <exec executable="hostname" osfamily="unix" failifexecutionfails="false" outputproperty="env.COMPUTERNAME"/>

    <property name="env.HOSTNAME" value="${env.COMPUTERNAME}"/>

    <tstamp>
        <format property="build.time" pattern="yyyy-MM-dd'T'HH:mm:ssZ" />
    </tstamp>

    <echo message="${build.time} ${user.name}@${env.HOSTNAME}" file="${basedir}/resources/META-INF/GNDMS-BUILD-INFO" />

    <loadfile srcfile="${basedir}/resources/META-INF/GNDMS-RELEASE" property="env.RELEASE" />

    <echo message="GNDMS RELEASE: ${env.RELEASE}" />
    <echo message="GNDMS BUILD: ${build.time} ${user.name}@${env.HOSTNAME}"/>
</target>

<target name="map" description="Calls the OpenJPA mapping tool to build the current schema">
	<mappingtool schemaaction="build"
	             indexes="true" foreignkeys="true" primarykeys="true"
	             sqlfile="stdout">
		<config
			  connectionDriverName="org.apache.derby.jdbc.EmbeddedDriver"
			  connectionURL="jdbc:derby:/opt/gt-current/etc/gndms_shared/db/gndms"
			  propertiesFile="resources/META-INF/persistence.xml"  />
                                                                           
		<classpath refid="enhancepath" />

		<!-- config
			  connectionDriverName="org.apache.derby.jdbc.EmbeddedDriver"
              connectionURL="jdbc:derby:/home/mjorra/tmp/C3GridTests/db/ModelActionTests"
			  propertiesFile="src/META-INF/persistence.xml"  / -->
    </mappingtool>
</target>  

</project>
